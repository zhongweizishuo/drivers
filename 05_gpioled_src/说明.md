# 1. 文件拆分说明
1. 把gpioled.c进行抽象,对整个驱动进行了拆分
2. gpioled.c : 驱动的主要框架
3. src/driver.hpp : 驱动主要函数的实现
# 2. 框架结构：
/* 0. 构建设备结构体 */

/* 1. 实例化一个设备 */
```c
    struct gpioled_dev gpioled;
```
/* 2.  构建设备操作函数 fops */
```c
    static struct file_operations gpioled_fops = {
        .owner = THIS_MODULE,
        .open = led_open,
        .read = led_read,
        .write = led_write,
        .release = 	led_release,
    };
```
/* 3. 驱动入口函数 */
```c
static int __init led_init(void)
{
	/* 1. 使用dts初始化LED所使用的GPIO */
	dts_led_init(gpioled);

	/* 2. 注册字符设备驱动 */
	regi_chr_dev(gpioled, gpioled_fops);
	return -EIO;
}
```
/* 4. 驱动出口函数 */
```c
static void __exit led_exit(void)
{
	// 注销字符设备驱动
	cdev_del(&gpioled.cdev);/*  删除cdev */
	unregister_chrdev_region(gpioled.devid, GPIOLED_CNT); /* 注销设备号 */
	device_destroy(gpioled.class, gpioled.devid);/* 注销设备 */
	class_destroy(gpioled.class);/* 注销类 */
	gpio_free(gpioled.led_gpio); /* 释放GPIO */
}
```
/* 5. 驱动入口与出口模块 */
```c
module_init(led_init);
module_exit(led_exit);
```
/* 6. 驱动模块信息 */
```c
MODULE_LICENSE("GPL");
MODULE_AUTHOR("zhong");
MODULE_INFO(intree, "Y");
```

# 3. driver.hpp 实现具体函数架构
0. head.h + 宏文件
1. gpioled设备结构体
```c
struct gpioled_dev{
	dev_t devid;			/* 设备号 	 */
	struct cdev cdev;		/* cdev 	*/
	struct class *class;	/* 类 		*/
	struct device *device;	/* 设备 	 */
	int major;				/* 主设备号	  */
	int minor;				/* 次设备号   */
	struct device_node	*nd; /* 设备节点 */
	int led_gpio;			/* led所使用的GPIO编号	*/
};
```
2. fops的4个操作函数(示意)
```c
static int led_open();
static int led_read();
static int led_write();
static int led_release();
```
3. 设备树属性读取与设备初始化
```c
static int __init dts_led_init(struct gpioled_dev dev);
```

4. 字符设备注册
```c
static void __init regi_chr_dev(struct gpioled_dev dev, struct file_operations dev_fops);
```
5. 字符设备卸载
```c
static void __init unregi_chr_dev(struct gpioled_dev dev);
```